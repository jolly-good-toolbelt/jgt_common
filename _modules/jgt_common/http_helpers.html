

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>jgt_common.http_helpers &mdash; jgt_common - A library for helper functions across Jolly Good Toolbelt designed for larger consumption 1.1.1 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> jgt_common - A library for helper functions across Jolly Good Toolbelt designed for larger consumption
          

          
          </a>

          
            
            
              <div class="version">
                1.1.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Library</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../jgt_common.html">jgt_common package</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../jgt_common.html#submodules">Submodules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../jgt_common.html#module-jgt_common.assert_">jgt_common.assert_ module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../jgt_common.html#module-jgt_common.check">jgt_common.check module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../jgt_common.html#module-jgt_common.futures">jgt_common.futures module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../jgt_common.html#module-jgt_common.http_helpers">jgt_common.http_helpers module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../jgt_common.html#module-jgt_common.tag_to_url">jgt_common.tag_to_url module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../jgt_common.html#module-jgt_common.uuid_replacer">jgt_common.uuid_replacer module</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Maintainers</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../MAINTAINER.html">Maintainerâ€™s Documentation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../MAINTAINER.html#top-level-scripts">Top-level scripts:</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../MAINTAINER.html#jgt-tools-scripts">JGT Tools scripts:</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../CONTRIBUTORS.html">Contributors</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">jgt_common - A library for helper functions across Jolly Good Toolbelt designed for larger consumption</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content style-external-links">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../jgt_common.html">jgt_common</a> &raquo;</li>
        
      <li>jgt_common.http_helpers</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for jgt_common.http_helpers</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Tools for simplifying HTTP requests and responses.&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">chain</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="kn">import</span> <span class="nn">requests</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">build_classification_rst_string</span><span class="p">,</span> <span class="n">classify</span><span class="p">,</span> <span class="n">no_op</span>


<span class="n">MAX_CALL_FAILURES</span> <span class="o">=</span> <span class="mi">5</span>

<span class="n">MAX_ERROR_MESSAGE_CONTENT_LENGTH</span> <span class="o">=</span> <span class="mi">500</span>

<span class="n">HEADERS_TO_IGNORE_IN_ERROR_MESSAGE</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;Accept-Encoding&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Connection&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Content-Length&quot;</span><span class="p">,</span>
    <span class="s2">&quot;User-Agent&quot;</span><span class="p">,</span>
    <span class="s2">&quot;X-Auth-Token&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">STATUS_CODE_RANGES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;a successful response&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">300</span><span class="p">),</span>
    <span class="s2">&quot;a client error&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="mi">500</span><span class="p">),</span>
    <span class="s2">&quot;a server error&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="mi">600</span><span class="p">),</span>
    <span class="s2">&quot;any error&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="mi">600</span><span class="p">),</span>
<span class="p">}</span>


<div class="viewcode-block" id="safe_json_from"><a class="viewcode-back" href="../../jgt_common.html#jgt_common.http_helpers.safe_json_from">[docs]</a><span class="nd">@classify</span><span class="p">(</span><span class="s2">&quot;json&quot;</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">safe_json_from</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Accept a response object and attempts to return the JSON-decoded data.</span>

<span class="sd">    Args:</span>
<span class="sd">        response (requests.models.Response): a Response object from a requests call</span>
<span class="sd">        description (str, optional): details about the response expected.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The JSON-decoded data from the response</span>

<span class="sd">    Raises:</span>
<span class="sd">        AssertionError: if the JSON data cannot be decoded properly.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># the json module in py2 doesn&#39;t contain the specific error,</span>
    <span class="c1"># and instead throws a generic ValueError</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">decode_error</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">decoder</span><span class="o">.</span><span class="n">JSONDecodeError</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="n">decode_error</span> <span class="o">=</span> <span class="ne">ValueError</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">decode_error</span><span class="p">:</span>
        <span class="n">content</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="nb">filter</span><span class="p">(</span>
                <span class="kc">None</span><span class="p">,</span>
                <span class="p">[</span>
                    <span class="n">description</span><span class="p">,</span>
                    <span class="s2">&quot;URL: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">url</span><span class="p">),</span>
                    <span class="s2">&quot;Status Code: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">),</span>
                    <span class="s2">&quot;Response Text -</span><span class="si">{}</span><span class="s2">-&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">),</span>
                <span class="p">],</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">format_items_as_string_tree</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Response Content NOT a Valid JSON:&quot;</span><span class="p">,</span> <span class="n">content</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="get_data_from_response"><a class="viewcode-back" href="../../jgt_common.html#jgt_common.http_helpers.get_data_from_response">[docs]</a><span class="nd">@classify</span><span class="p">(</span><span class="s2">&quot;response&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_data_from_response</span><span class="p">(</span>
    <span class="n">response</span><span class="p">,</span> <span class="n">dig_layers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">check_empty</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">first_only</span><span class="o">=</span><span class="kc">True</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Accept a response object and returns a dict of the data contained within.</span>

<span class="sd">    Args:</span>
<span class="sd">        response (requests.models.Response): A Response object from a requests call</span>
<span class="sd">        dig_layers (list): List of keys to &quot;dig&quot; down into the response before returning</span>
<span class="sd">        check_empty (bool): If True, raises an AssertionError if the payload is empty</span>
<span class="sd">        first_only (bool): Strip the list wrapping the data and return the first result</span>

<span class="sd">    Returns:</span>
<span class="sd">        The data payload.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; response.json() == {&quot;data&quot;: [{&quot;key&quot;: &quot;value&quot;}, {&quot;key&quot;: &quot;value2&quot;}],</span>
<span class="sd">                                &quot;other&quot;: &quot;&quot;}</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; get_data_from_response(response, dig_layers=[&#39;data&#39;])</span>
<span class="sd">        {&#39;key&#39;: &#39;value&#39;}</span>
<span class="sd">        &gt;&gt;&gt; get_data_from_response(response, dig_layers=[&#39;data&#39;], first_only=False)</span>
<span class="sd">        [{&#39;key&#39;: &#39;value&#39;}, {&#39;key&#39;: &#39;value2&#39;}]</span>
<span class="sd">        &gt;&gt;&gt; get_data_from_response(response, dig_layers=[&#39;other&#39;])</span>
<span class="sd">        AssertionError: Payload was empty: &#39;&#39;</span>
<span class="sd">        &gt;&gt;&gt; get_data_from_response(response, dig_layers=[&#39;other&#39;], check_empty=False)</span>
<span class="sd">        &quot;&quot;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># most common response is a &#39;list&#39; of only one element, so first_only=True</span>
    <span class="c1"># will fix that by default, but allows a toggle to get full data if desired.</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">safe_json_from</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)):</span>
        <span class="k">return</span> <span class="n">data</span>
    <span class="n">dig_layers</span> <span class="o">=</span> <span class="n">dig_layers</span> <span class="ow">or</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">dig_layers</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">first_only</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">check_empty</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">data</span><span class="p">,</span> <span class="s2">&quot;Payload was empty: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="get_data_list"><a class="viewcode-back" href="../../jgt_common.html#jgt_common.http_helpers.get_data_list">[docs]</a><span class="nd">@classify</span><span class="p">(</span><span class="s2">&quot;response&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_data_list</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the full list of data from within a response, if the data is a list.</span>

<span class="sd">    Helper around get_data_for_response that returns the full list of data</span>
<span class="sd">    if the data is in a list format, rather than the default of returning</span>
<span class="sd">    the first object inside the list.</span>

<span class="sd">    For ``**kwargs`` values and more information, see :py:func:`get_data_from_response`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">first_only</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">get_data_from_response</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_indent_items</span><span class="p">(</span><span class="o">*</span><span class="n">items</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Indent all items recursively.</span>

<span class="sd">    Adds a tab to every item in ``*items``. If the item is a list, this function</span>
<span class="sd">    will be recursively called with the contents of that list, adding an additional</span>
<span class="sd">    tab stop.  Each additional nested list will result in an additional tab for every</span>
<span class="sd">    item in that additional list.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: The items given, with all nested items having an added indent.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt;_indent_items(&#39;ex1&#39;, [&#39;nested1&#39;, &#39;nested2&#39;, [&#39;double1&#39;], [&#39;double2&#39;]])</span>
<span class="sd">        [&#39;\tex1&#39;, &#39;\t\tnested1&#39;, &#39;\t\tnested2&#39;, &#39;\t\t\tdouble1&#39;, &#39;\t\t\tdouble2&#39;]</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="s2">&quot;</span><span class="se">\t</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">items</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">(</span><span class="n">_indent_items</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">x</span><span class="p">])</span>
    <span class="p">]</span>


<div class="viewcode-block" id="format_items_as_string_tree"><a class="viewcode-back" href="../../jgt_common.html#jgt_common.http_helpers.format_items_as_string_tree">[docs]</a><span class="nd">@classify</span><span class="p">(</span><span class="s2">&quot;string&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">format_items_as_string_tree</span><span class="p">(</span><span class="o">*</span><span class="n">items</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Format the items provided as a string representing a &quot;tree&quot; format.</span>

<span class="sd">    Any lists or nested lists will be flattened, with each level of nested lists</span>
<span class="sd">    getting its own level of indentation. Each item, once flattened with the</span>
<span class="sd">    appropriate level of indentation provided, will be placed on its own line.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: An indented &quot;tree&quot; format of the items.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; format_items_as_string_tree(&#39;ex1&#39;, &#39;ex2&#39;, [&#39;nested1&#39;, &#39;nested2&#39;,</span>
<span class="sd">        &gt;&gt;&gt;                             [&#39;double1&#39;], [&#39;double2&#39;]], &#39;ex3&#39;)</span>
<span class="sd">            ex1</span>
<span class="sd">            ex2</span>
<span class="sd">                nested1</span>
<span class="sd">                nested2</span>
<span class="sd">                    double1</span>
<span class="sd">                    double2</span>
<span class="sd">            ex3</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_indent_items</span><span class="p">(</span><span class="o">*</span><span class="n">items</span><span class="p">))</span></div>


<span class="k">def</span> <span class="nf">_status_code_from</span><span class="p">(</span><span class="n">status_description</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">status_description</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">status_description</span>
    <span class="k">return</span> <span class="n">requests</span><span class="o">.</span><span class="n">codes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">status_description</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>


<div class="viewcode-block" id="is_status_code"><a class="viewcode-back" href="../../jgt_common.html#jgt_common.http_helpers.is_status_code">[docs]</a><span class="nd">@classify</span><span class="p">(</span><span class="s2">&quot;status_code&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">is_status_code</span><span class="p">(</span><span class="n">expected_status_description</span><span class="p">,</span> <span class="n">actual_status_code</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine if a given status code matches the expected result.</span>

<span class="sd">    Args:</span>
<span class="sd">        expected_status_description (str, int): The result to match. Can be:</span>
<span class="sd">            - A Python requests libarary status reason (&quot;OK&quot;)</span>
<span class="sd">            - A phrase matching a ``_status_code_ranges`` key (&#39;a client error&#39;)</span>
<span class="sd">            - An integer for the response status code (404)</span>
<span class="sd">        actual_status_code (int): the status code from the response to be validated</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: Whether or not the actual status code matches the expected description.</span>

<span class="sd">    Raises:</span>
<span class="sd">        AssertionError: if an invalid ``expected_status_description`` value is provided.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">expected_status_description</span> <span class="ow">in</span> <span class="n">STATUS_CODE_RANGES</span><span class="p">:</span>
        <span class="c1"># a range descriptor was provided</span>
        <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="n">STATUS_CODE_RANGES</span><span class="p">[</span><span class="n">expected_status_description</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">lower</span> <span class="o">&lt;=</span> <span class="n">actual_status_code</span> <span class="o">&lt;</span> <span class="n">upper</span>

    <span class="c1"># Convert description to code if not provided as code</span>
    <span class="n">expected_code</span> <span class="o">=</span> <span class="n">_status_code_from</span><span class="p">(</span><span class="n">expected_status_description</span><span class="p">)</span>
    <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Coding error, unknown status code check &quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">expected_status_description</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="n">expected_code</span><span class="p">,</span> <span class="n">message</span>
    <span class="k">return</span> <span class="n">expected_code</span> <span class="o">==</span> <span class="n">actual_status_code</span></div>


<div class="viewcode-block" id="create_error_message"><a class="viewcode-back" href="../../jgt_common.html#jgt_common.http_helpers.create_error_message">[docs]</a><span class="nd">@classify</span><span class="p">(</span><span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">create_error_message</span><span class="p">(</span><span class="n">summary_line</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response_content</span><span class="p">,</span> <span class="n">additional_info</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a detailed error message based on an API call.</span>

<span class="sd">    This message will include information about the request and response,</span>
<span class="sd">    cutting off the response content at the set ``MAX_ERROR_MESSAGE_CONTENT_LENGTH``.</span>
<span class="sd">    Additional information can be included in the message by including the</span>
<span class="sd">    ``additional_info`` parameter.</span>

<span class="sd">    Args:</span>
<span class="sd">        summary_line (str): The first line of the message that describes the error.</span>
<span class="sd">        request (Request): The python requests library Request.</span>
<span class="sd">        response_content (str): The response content to be included in the response.</span>
<span class="sd">        additional_info (dict): A dictionary containing additional information to be</span>
<span class="sd">            included in the message. The keys and values will be separated by a</span>
<span class="sd">            ``&quot;:&quot;`` in the message. (optional)</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: The complete and detailed error message.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">additional_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">additional_info</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">header</span><span class="p">:</span> <span class="n">value</span>
        <span class="k">for</span> <span class="n">header</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">header</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">HEADERS_TO_IGNORE_IN_ERROR_MESSAGE</span>
    <span class="p">}</span>

    <span class="n">response_content</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">response_content</span><span class="p">)[:</span><span class="n">MAX_ERROR_MESSAGE_CONTENT_LENGTH</span><span class="p">]</span>
    <span class="n">request_body</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">)[:</span><span class="n">MAX_ERROR_MESSAGE_CONTENT_LENGTH</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">format_items_as_string_tree</span><span class="p">(</span>
        <span class="n">summary_line</span><span class="p">,</span>
        <span class="p">[</span>
            <span class="s2">&quot;Request Info:&quot;</span><span class="p">,</span>
            <span class="p">[</span>
                <span class="s2">&quot;Url: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">),</span>
                <span class="s2">&quot;HTTP Method: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="p">),</span>
                <span class="s2">&quot;Headers: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">headers</span><span class="p">),</span>
                <span class="s2">&quot;Body: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">request_body</span><span class="p">),</span>
            <span class="p">],</span>
        <span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">additional_info</span><span class="o">.</span><span class="n">items</span><span class="p">()],</span>
        <span class="p">[</span><span class="s2">&quot;Response Content: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">response_content</span><span class="p">)],</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="check_response_status_code"><a class="viewcode-back" href="../../jgt_common.html#jgt_common.http_helpers.check_response_status_code">[docs]</a><span class="nd">@classify</span><span class="p">(</span><span class="s2">&quot;status_code&quot;</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">check_response_status_code</span><span class="p">(</span>
    <span class="n">expected_status_description</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">call_description</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">additional_info</span><span class="o">=</span><span class="kc">None</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check that a response&#39;s status code matches an expected status description.</span>

<span class="sd">    Args:</span>
<span class="sd">        expected_status_description (str, int): The expected HTTP response status</span>
<span class="sd">            reason or code.</span>
<span class="sd">        response (Response): The python requests library response to validate.</span>
<span class="sd">        call_description (str): additional details about the call placed (optional)</span>
<span class="sd">        additional_info (dict): Additional Info to be passed to create_error_message</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: Empty string if response status code matches, or a detailed error message</span>
<span class="sd">            otherwise</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">is_status_code</span><span class="p">(</span><span class="n">expected_status_description</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">response_content</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">safe_json_from</span><span class="p">(</span><span class="n">response</span><span class="p">),</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
        <span class="n">response_content</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span>

    <span class="n">status_message</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> - Actual Response Status: </span><span class="si">{}</span><span class="s2">&quot;</span>
    <span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;Expected Status&quot;</span><span class="p">:</span> <span class="n">status_message</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">expected_status_description</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span>
        <span class="p">),</span>
        <span class="s2">&quot;Reason&quot;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">reason</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">info</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">additional_info</span> <span class="ow">or</span> <span class="p">{})</span>
    <span class="k">if</span> <span class="n">call_description</span><span class="p">:</span>
        <span class="n">info</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;Call Description&quot;</span><span class="p">:</span> <span class="n">call_description</span><span class="p">})</span>
    <span class="n">err_msg</span> <span class="o">=</span> <span class="n">create_error_message</span><span class="p">(</span>
        <span class="n">summary_line</span><span class="o">=</span><span class="s2">&quot;The response status does not match the expected status.&quot;</span><span class="p">,</span>
        <span class="n">request</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">request</span><span class="p">,</span>
        <span class="n">response_content</span><span class="o">=</span><span class="n">response_content</span><span class="p">,</span>
        <span class="n">additional_info</span><span class="o">=</span><span class="n">info</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">err_msg</span></div>


<div class="viewcode-block" id="validate_response_status_code"><a class="viewcode-back" href="../../jgt_common.html#jgt_common.http_helpers.validate_response_status_code">[docs]</a><span class="nd">@classify</span><span class="p">(</span><span class="s2">&quot;status_code&quot;</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">validate_response_status_code</span><span class="p">(</span>
    <span class="n">expected_status_description</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">err_prefix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Assert that a response&#39;s status code matches an expected status code.</span>

<span class="sd">    Args:</span>
<span class="sd">        expected_status_description (str, int): The expected HTTP response status reason</span>
<span class="sd">            or code.</span>
<span class="sd">        response (Response): The python requests library response to validate.</span>
<span class="sd">        err_prefix (str, optional): Prefix, if any, to the error message, when an</span>
<span class="sd">            assertion is raised.</span>
<span class="sd">        kwargs: additional keyword args to be passed on to check_response_status_code.</span>

<span class="sd">    Raises:</span>
<span class="sd">        AssertionError: if the response status validation fails</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">err_msg</span> <span class="o">=</span> <span class="n">check_response_status_code</span><span class="p">(</span>
        <span class="n">expected_status_description</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">err_msg</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="n">err_prefix</span> <span class="o">+</span> <span class="n">err_msg</span><span class="p">)</span></div>


<div class="viewcode-block" id="response_if_status_check"><a class="viewcode-back" href="../../jgt_common.html#jgt_common.http_helpers.response_if_status_check">[docs]</a><span class="nd">@classify</span><span class="p">(</span><span class="s2">&quot;status_code&quot;</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">response_if_status_check</span><span class="p">(</span>
    <span class="n">call_description</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">target_status</span><span class="o">=</span><span class="s2">&quot;a successful response&quot;</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validate a response matches the expected status code before returning.</span>

<span class="sd">    Args:</span>
<span class="sd">        call_description (str): Text description of the call placed</span>
<span class="sd">            (e.g. &quot;get schedule list&quot;)</span>
<span class="sd">        response (requests.Response): the response object to validate.</span>
<span class="sd">        target_status (str, int): The expected HTTP response status reason or code.</span>

<span class="sd">    Returns:</span>
<span class="sd">        requests.Response: if the response status validation succeeds</span>

<span class="sd">    Raises:</span>
<span class="sd">        AssertionError: if the response status validation fails</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">validate_response_status_code</span><span class="p">(</span>
        <span class="n">target_status</span><span class="p">,</span>
        <span class="n">response</span><span class="p">,</span>
        <span class="n">call_description</span><span class="o">=</span><span class="s1">&#39;Call to &quot;</span><span class="si">{}</span><span class="s1">&quot; failed&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">call_description</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span></div>


<div class="viewcode-block" id="safe_request_validator"><a class="viewcode-back" href="../../jgt_common.html#jgt_common.http_helpers.safe_request_validator">[docs]</a><span class="nd">@classify</span><span class="p">(</span><span class="s2">&quot;response&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">safe_request_validator</span><span class="p">(</span>
    <span class="n">inner_validator</span><span class="p">,</span> <span class="n">max_failures</span><span class="o">=</span><span class="n">MAX_CALL_FAILURES</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrap a ``check_request_until`` validator in additional response checks.</span>

<span class="sd">    Will &quot;fail fast&quot; in the case of an ``unauthorized`` response,</span>
<span class="sd">    and will support retrying calls if a non-200-level reponse status is returned.</span>

<span class="sd">    Args:</span>
<span class="sd">        inner_validator (function): case-specific response validator function,</span>
<span class="sd">            should return False if condition is not met and re-checking should continue,</span>
<span class="sd">            or True if target status is complete and result should be returned.</span>
<span class="sd">        max_failures (int): total number of retries *per cycle* a call should be allowed</span>
<span class="sd">            before failing permanently and returning the last response</span>
<span class="sd">        logger (logging.logger, optional): a logger to handle debug messages from the</span>
<span class="sd">            validator</span>

<span class="sd">    Returns:</span>
<span class="sd">        function: response-status-checking decorated version of ``inner_validator``</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">debug</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">debug</span> <span class="k">if</span> <span class="n">logger</span> <span class="k">else</span> <span class="n">no_op</span>
    <span class="c1"># In Python 3+, modification of outer scope variables is achievable</span>
    <span class="c1"># with the ``nonlocal`` keyword,</span>
    <span class="c1"># but for 2.7 compatibility, we must access and modify via a dictionary.</span>
    <span class="n">failures</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;fail_count&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">is_status_code</span><span class="p">(</span><span class="s2">&quot;unauthorized&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">max_failures</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_status_code</span><span class="p">(</span>
            <span class="s2">&quot;a successful response&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span>
        <span class="p">):</span>
            <span class="n">failures</span><span class="p">[</span><span class="s2">&quot;fail_count&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">failures</span><span class="p">[</span><span class="s2">&quot;fail_count&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">max_failures</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;***Call failed </span><span class="si">{}</span><span class="s2"> times, final status code was </span><span class="si">{}</span><span class="s2">.&quot;</span>
            <span class="n">debug</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">failures</span><span class="p">[</span><span class="s2">&quot;fail_count&quot;</span><span class="p">],</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">))</span>
        <span class="n">failures</span><span class="p">[</span><span class="s2">&quot;fail_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">inner_validator</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">inner</span></div>


<div class="viewcode-block" id="call_with_custom_logger"><a class="viewcode-back" href="../../jgt_common.html#jgt_common.http_helpers.call_with_custom_logger">[docs]</a><span class="nd">@classify</span><span class="p">(</span><span class="s2">&quot;logging&quot;</span><span class="p">)</span>
<span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">call_with_custom_logger</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="n">curl_logger</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Context Manager to make a call with a given curl_logger in place of the default.</span>

<span class="sd">    If curl_logger is a last-only logger, call ``.done()`` on context exit.</span>
<span class="sd">    NOTE: for last-only loggers, the log will not be written until you exit the context.</span>

<span class="sd">    Example:</span>
<span class="sd">        Create a new callable based on &#39;call&#39; that uses the logger &#39;logger_to_use&#39;::</span>

<span class="sd">            with call_with_custom_logger(call, logger_to_use) as call_using_logger:</span>
<span class="sd">                some_result = check_until(call_using_logger, ...)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">curl_logger</span> <span class="o">=</span> <span class="n">curl_logger</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">curl_logger</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="k">else</span> <span class="n">curl_logger</span>

    <span class="k">def</span> <span class="nf">custom_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">curl_logger</span><span class="o">=</span><span class="n">curl_logger</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">yield</span> <span class="n">custom_call</span>

    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">curl_logger</span><span class="p">,</span> <span class="s2">&quot;done&quot;</span><span class="p">):</span>
        <span class="n">curl_logger</span><span class="o">.</span><span class="n">done</span><span class="p">()</span></div>


<span class="vm">__doc__</span> <span class="o">+=</span> <span class="n">build_classification_rst_string</span><span class="p">(</span>
    <span class="nb">globals</span><span class="p">(),</span>
    <span class="vm">__name__</span><span class="p">,</span>
    <span class="p">{</span>
        <span class="s2">&quot;json&quot;</span><span class="p">:</span> <span class="s2">&quot;JSON related functions&quot;</span><span class="p">,</span>
        <span class="s2">&quot;logging&quot;</span><span class="p">:</span> <span class="s2">&quot;Logging related functions&quot;</span><span class="p">,</span>
        <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="s2">&quot;Requests&#39; Response object related functions&quot;</span><span class="p">,</span>
        <span class="s2">&quot;status_code&quot;</span><span class="p">:</span> <span class="s2">&quot;HTTP Status code functions&quot;</span><span class="p">,</span>
        <span class="s2">&quot;string&quot;</span><span class="p">:</span> <span class="s2">&quot;String related functions&quot;</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">)</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Doug Philips, Lewis Franklin, Ryan Casperson, Brad Brown, Shawn Dutton
      <span class="build">
        
        Build
        <a href="https://github.com/jolly-good-toolbelt/jgt_common/tree/5a1959152a58e1e6e5ff8b78566fe13fc4faf774">5a1959152a58e1e6e5ff8b78566fe13fc4faf774</a>.
      </span>

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>